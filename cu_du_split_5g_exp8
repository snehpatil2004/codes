clc;
clear;
close all;

% Required Toolbox: 5G Toolbox, Communications Toolbox

%% Simulation Parameters
simTime = 1;             % Simulation duration in seconds
numFrames = 20;          % Number of 5G NR frames simulated
frameDuration = 10e-3;   % 10 ms frame duration in 5G NR
fronthaulLatencyRange = 0:0.5:5;  % Fronthaul latency values in ms

% Data rates (bps) assumptions for illustration
baseDataRateSA = 1e9;    % 1 Gbps baseline for Standalone
baseDataRateNSA = 1.2e9; % 1.2 Gbps baseline for Non-Standalone (due to LTE anchor)

% Latency assumptions (processing + transport) without fronthaul delay (in ms)
processingLatencyCU = 0.1;
processingLatencyDU = 0.1;

%% Initialize arrays to hold results
latencySA = zeros(size(fronthaulLatencyRange));
latencyNSA = zeros(size(fronthaulLatencyRange));
throughputSA = zeros(size(fronthaulLatencyRange));
throughputNSA = zeros(size(fronthaulLatencyRange));

%% Simulate varying fronthaul latency impact
for idx = 1:length(fronthaulLatencyRange)
    fhLatency = fronthaulLatencyRange(idx);
    
    % Total latency = fronthaul + CU/DU processing delays
    totalLatencySA = processingLatencyCU + processingLatencyDU + fhLatency;
    totalLatencyNSA = processingLatencyCU + processingLatencyDU + fhLatency / 2; % NSA assumed less latency
    
    latencySA(idx) = totalLatencySA;
    latencyNSA(idx) = totalLatencyNSA;
    
    % Throughput affected inversely by latency (simplified)
    throughputSA(idx) = baseDataRateSA * (1 - min(totalLatencySA/10, 0.9));
    throughputNSA(idx) = baseDataRateNSA * (1 - min(totalLatencyNSA/10, 0.9));
end

%% Plot Latency vs Fronthaul Latency
figure;
plot(fronthaulLatencyRange, latencySA, '-o', 'LineWidth', 2, 'DisplayName', 'Standalone (SA)');
hold on;
plot(fronthaulLatencyRange, latencyNSA, '-s', 'LineWidth', 2, 'DisplayName', 'Non-Standalone (NSA)');
grid on;
xlabel('Fronthaul Latency (ms)');
ylabel('Total Latency (ms)');
title('Latency vs Fronthaul Latency for SA and NSA 5G Modes');
legend('Location','northwest');
hold off;

%% Plot Throughput vs Fronthaul Latency
figure;
plot(fronthaulLatencyRange, throughputSA/1e9, '-o', 'LineWidth', 2, 'DisplayName', 'Standalone (SA)');
hold on;
plot(fronthaulLatencyRange, throughputNSA/1e9, '-s', 'LineWidth', 2, 'DisplayName', 'Non-Standalone (NSA)');
grid on;
xlabel('Fronthaul Latency (ms)');
ylabel('Throughput (Gbps)');
title('Throughput vs Fronthaul Latency for SA and NSA 5G Modes');
legend('Location','northeast');
hold off;

%% Protocol Stack Visualization

% Define layers for user plane and control plane stacks for SA and NSA
layers = {'RLC', 'PDCP', 'SDAP', 'RRC', 'NAS'}; % Common control/user plane layers

% Standalone mode stacks (CU + DU)
SA_UserPlane = {'PHY-DU', 'MAC-DU', 'RLC-CU', 'PDCP-CU', 'SDAP-CU'};
SA_ControlPlane = {'PHY-DU', 'MAC-DU', 'RLC-CU', 'PDCP-CU', 'RRC-CU', 'NAS'};

% Non-Standalone mode stacks (DU linked to LTE eNodeB)
NSA_UserPlane = {'PHY-DU', 'MAC-DU', 'RLC-LTE', 'PDCP-LTE', 'SDAP-LTE'};
NSA_ControlPlane = {'PHY-DU', 'MAC-DU', 'RLC-LTE', 'PDCP-LTE', 'RRC-LTE', 'NAS'};

% Create figure for protocol stack
figure('Name','Protocol Stack Visualization','Position',[100, 100, 900, 600]);

subplot(2,2,1);
barh(1:length(SA_UserPlane), ones(1,length(SA_UserPlane)), 'FaceColor', [0 0.4470 0.7410]);
set(gca,'yticklabel',SA_UserPlane,'ytick',1:length(SA_UserPlane));
title('SA User Plane Stack');
xlabel('Layer Activity');
xlim([0 1.5]);

subplot(2,2,2);
barh(1:length(SA_ControlPlane), ones(1,length(SA_ControlPlane)), 'FaceColor', [0.8500 0.3250 0.0980]);
set(gca,'yticklabel',SA_ControlPlane,'ytick',1:length(SA_ControlPlane));
title('SA Control Plane Stack');
xlabel('Layer Activity');
xlim([0 1.5]);

subplot(2,2,3);
barh(1:length(NSA_UserPlane), ones(1,length(NSA_UserPlane)), 'FaceColor', [0.4660 0.6740 0.1880]);
set(gca,'yticklabel',NSA_UserPlane,'ytick',1:length(NSA_UserPlane));
title('NSA User Plane Stack');
xlabel('Layer Activity');
xlim([0 1.5]);

subplot(2,2,4);
barh(1:length(NSA_ControlPlane), ones(1,length(NSA_ControlPlane)), 'FaceColor', [0.4940 0.1840 0.5560]);
set(gca,'yticklabel',NSA_ControlPlane,'ytick',1:length(NSA_ControlPlane));
title('NSA Control Plane Stack');
xlabel('Layer Activity');
xlim([0 1.5]);

sgtitle('5G Base Station Protocol Stack: CU-DU Split in SA vs NSA Modes');

%% Command window summary
fprintf('\n5G CU-DU Split Architecture Simulation Analysis:\n');
fprintf(' - Fronthaul latency linearly increases total latency in both SA and NSA modes.\n');
fprintf(' - NSA mode exhibits lower latency due to reliance on LTE core and optimized processing split.\n');
fprintf(' - Throughput decreases as fronthaul latency increases, with SA mode being slightly lower throughput\n');
fprintf('   due to more end-to-end 5G stack processing.\n');
fprintf(' - Protocol stack visualization shows additional layers involved in SA mode compared to NSA.\n');
fprintf(' - This simulation provides a simplified but insightful view of the impact of CU-DU split and deployment modes.\n\n');

	
